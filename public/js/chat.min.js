$(document).ready(function(){const e='http://localhost/myportpolio/workorder/public/',function s(){const s=$(".id_sender").val(),t=$(".id_receiver").val(),a=$(".img-profile").data("profil"),i=$("div.chat_list#"+t).data("profil");$(".id_receiver").val(t),$.ajax({url:e+"chat/getChatdetail",data:{id_receiver:t,id_sender:s},method:"post",dataType:"json",success:function(t){if($(".incoming_msg").remove(),$(".outgoing_msg").remove(),$(".unread_msg").remove(),t.length>0){let o="",d=0;for(let e=0;e<t.length;e++)t[e].to_user==s&&0==t[e].readed&&d++;for(let m=0;m<t.length;m++)t[m].to_user==s?(0==t[m].readed&&t[m].readed!=o&&$(".msg_history").append('<div class="unread_msg"><div class="unread_withd_msg"><p>'+d+" unread message</p></div></div>"),$(".msg_history").append('<div class="incoming_msg"><div class="incoming_msg_img"> <img src="'+e+"/img/profile/"+i+'" alt="'+i+'"></div><div class="received_msg"><div class="received_withd_msg"><p>'+t[m].chat_message+'</p><span class="time_date">'+moment(t[m].chat_time).format("D MMM YY")+" | "+moment(t[m].chat_time).format("LT")+"</span></div></div></div>")):$(".msg_history").append('<div class="outgoing_msg"><div class="outgoing_msg_img"> <img src="'+e+"/img/profile/"+a+'" alt="'+a+'"> </div><div class="sent_msg"><p>'+t[m].chat_message+'</p><span class="time_date_out">'+moment(t[m].chat_time).format("D MMM YY")+" | "+moment(t[m].chat_time).format("LT")+"</span></div></div>"),o=t[m].readed}}})}s(),setInterval(function(){s(),function(){const s=$(".id_sender").val(),t=$(".id_receiver").val();$.ajax({url:e+"chat/getUpdatelastchat",data:{id_sender:s},method:"post",dataType:"json",success:function(e){for(let s=0;s<e.length;s++)$(".chat_list#"+e[s].from_user+" h5").removeClass("text-primary font-weight-bold"),$(".chat_list#"+e[s].from_user+" h5").addClass("text-primary font-weight-bold"),$(".chat_list#"+e[s].from_user+" p span").remove(),$(".chat_list#"+e[s].from_user+" p").append('<span data-toggle="tooltip" title="'+e[s].jml+' New Messages" class="badge badge-primary float-right unreaded'+t+'">'+e[s].jml+"</span>")}}),$.ajax({url:e+"chat/getOnline",data:{id_sender:s},method:"post",dataType:"json",success:function(e){for(let s=0;s<e.length;s++){let t=Date.parse(e[s].last_activity),a=Date.parse(moment()),i=a-t;i<=18e5?($(".chat_list#"+e[s].id_user+" img").removeClass("online"),$(".chat_list#"+e[s].id_user+" img").removeClass("offline"),$(".chat_list#"+e[s].id_user+" img").addClass("online")):($(".chat_list#"+e[s].id_user+" img").removeClass("online"),$(".chat_list#"+e[s].id_user+" img").removeClass("offline"),$(".chat_list#"+e[s].id_user+" img").addClass("offline"))}}})}()},5e3),setInterval(function(){!function(){const s=$(".id_sender").val();$.ajax({url:e+"chat/updateLastactivity",data:{id_sender:s},method:"post",dataType:"json",success:function(e){}})}()},6e4),$(".msg_history").scroll(function(s){if($(".msg_history").scrollTop()>=$(".msg_history")[0].scrollHeight-$(".msg_history").height()){const s=$(".id_sender").val(),t=$(".id_receiver").val();$.ajax({url:e+"chat/readChat",data:{id_receiver:t,id_sender:s},method:"post",dataType:"json",success:function(e){$(".unreaded"+t).remove(),$("div.chat_list#"+t+" h5").removeClass("text-primary font-weight-bold"),$(".unread_msg").remove()}})}}),$(".chat_list").on("click",function(){const s=$(".id_sender").val(),t=$(this).data("iduser"),a=$(".img-profile").data("profil"),i=$(this).data("profil"),o=$(this).data("nama"),d=$(this).data("status"),m=$(this).data("login"),r=moment(m).format("D MMM YY")+" | "+moment(m).format("LT");$(".id_receiver").val(t),$("div.chat_list").removeClass("active_chat"),$("div.chat_list#"+t).addClass("active_chat"),$.ajax({url:e+"chat/getChatdetail",data:{id_receiver:t,id_sender:s},method:"post",dataType:"json",success:function(t){$(".user-info > p").remove();let m="text-danger";if("online"==d&&(m="text-success"),$(".user-info").append('<p class="font-weight-bold ml-3"><i class="fas fa-circle '+m+' shadow-lg mr-2"></i>'+o+'<span class="small text-gray-500 ml-2">('+d+')</span><span class="small text-gray-500 ml-3">last seen at '+r+"</span></p>"),$(".incoming_msg").remove(),$(".outgoing_msg").remove(),$(".unread_msg").remove(),t.length>0){let o="",d=0;for(let e=0;e<t.length;e++)t[e].to_user==s&&0==t[e].readed&&d++;for(let m=0;m<t.length;m++)t[m].to_user==s?(0==t[m].readed&&t[m].readed!=o&&$(".msg_history").append('<div class="unread_msg"><div class="unread_withd_msg"><p>'+d+" unread message</p></div></div>"),$(".msg_history").append('<div class="incoming_msg"><div class="incoming_msg_img"> <img src="'+e+"/img/profile/"+i+'" alt="'+i+'"></div><div class="received_msg"><div class="received_withd_msg"><p>'+t[m].chat_message+'</p><span class="time_date">'+moment(t[m].chat_time).format("D MMM YY")+" | "+moment(t[m].chat_time).format("LT")+"</span></div></div></div>")):$(".msg_history").append('<div class="outgoing_msg"><div class="outgoing_msg_img"> <img src="'+e+"/img/profile/"+a+'" alt="'+a+'"> </div><div class="sent_msg"><p>'+t[m].chat_message+'</p><span class="time_date_out">'+moment(t[m].chat_time).format("D MMM YY")+" | "+moment(t[m].chat_time).format("LT")+"</span></div></div>"),o=t[m].readed}var n=$(".msg_history")[0].scrollHeight-$(".msg_history").height();$(".msg_history").animate({scrollTop:n},1e3)}})}),$(".msg_send_btn").on("click",function(){const s=$(".write_msg").val(),t=$(".id_sender").val(),a=$(".id_receiver").val(),i=$(".img-profile").data("profil");$(".write_msg").val(""),$('input[name="chat_message"]').focus(),$.ajax({url:e+"chat/saveChat",data:{id_receiver:a,id_sender:t,chat:s},method:"post",dataType:"json",success:function(t){t>0&&($(".msg_history").append('<div class="outgoing_msg"><div class="outgoing_msg_img"> <img src="'+e+"/img/profile/"+i+'" alt="'+i+'"> </div><div class="sent_msg"><p>'+s+'</p><span class="time_date_out">'+moment().format("D MMM YY")+" | "+moment().format("LT")+"</span></div></div>"),$(".chat_list#"+a+" p").html(s),$(".chat_list#"+a+"h5 span").html(moment().format("D MMM YY")+" | "+moment().format("LT")));var o=$(".msg_history")[0].scrollHeight-$(".msg_history").height();$(".msg_history").animate({scrollTop:o},1e3)}})})});